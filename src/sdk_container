#!/bin/bash

set -euo pipefail

function run_in_sniper() {
    script_file=$(basename -- "$script")
    check_env=$(sha256sum -- "$script" | cut -d " " -f 1)

    if [[ ! -f /run/.containerenv ]]; then
        # Check if podman exists
        if ! command -v podman &> /dev/null; then
            echo "Error: podman is not installed. Exiting..."
            exit 1
        fi

        # Check if we're running in a container
        mod_src_dir=$(pwd)
        mod_src_dir_name=$(basename -- "$mod_src_dir")
        mod_base_dir=$(dirname -- "$mod_src_dir")

        # Setup ccache directory if not disabled
        ccache_args=""
        if [[ -z "${CCACHE_DISABLE:-}" ]]; then
            ccache_dir="${CCACHE_DIR:-$HOME/.ccache}"
            mkdir -p "$ccache_dir"
            ccache_args="--env CCACHE_DIR=/ccache --env CCACHE_BASEDIR=/my_mod/src --volume $ccache_dir:/ccache:rw"
        fi

        image="registry.gitlab.steamos.cloud/steamrt/sniper/sdk:latest"
        echo "Running script inside $image"
        exec podman run \
            --env "$check_env=$script_file" \
            $ccache_args \
            --volume "$mod_base_dir:/my_mod:rw" \
            --workdir "/my_mod/$mod_src_dir_name" \
            --rm \
            "$image" \
            "./$script_file" "$@"
    fi

    # At this point, we're already inside the container.
    # Verify we are running the right script (security check)
    our_sum=$(sha256sum -- "./$script_file" | cut -d " " -f 1)
    their_sum="${!check_env}"

    if [[ "$our_sum" != "$their_sum" ]]; then
        echo "Error: Script checksum mismatch. Aborting..."
        exit 1
    fi
}
